<!doctype html>
<html lang="en-us">
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <meta name="referrer" content="no-referrer-when-downgrade">
    

    <title>hpa 源码分析 | zoux的博客</title>
    <meta property="og:title" content="hpa 源码分析 - zoux的博客">
    <meta property="og:type" content="article">
        
    <meta property="article:published_time" content='2021-06-18T00:30:20&#43;08:00'>
        
        
    <meta property="article:modified_time" content='2021-06-18T00:30:20&#43;08:00'>
        
    <meta name="Keywords" content="golang,go语言,go语言笔记,zoux,k8s,Kubernetes,docker,kubeflow">
    <meta name="description" content="hpa 源码分析">
        
    <meta name="author" content="zoux">
    <meta property="og:url" content="https://zoux86.github.io/post/2021-6-18-hpa%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">
    <link rel="shortcut icon" href='/favicon.ico'  type="image/x-icon">

    <link rel="stylesheet" href='/css/normalize.css'>
    <link rel="stylesheet" href='/css/style.css'>
    <script type="text/javascript" src="//cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    
    
    
    
    
    
</head>


<body>
    <header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="https://zoux86.github.io/">
                        zoux的博客
                    </a>
                
                <p class="description">对Go语言(golang)、k8s、kubeflow，容器云，云原生感兴趣</p>
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="current" href="https://zoux86.github.io/">首页</a>
                    
                    <a  href="https://zoux86.github.io/tools/" title="工具">工具</a>
                    
                    <a  href="https://zoux86.github.io/archives/" title="归档">归档</a>
                    
                    <a  href="https://zoux86.github.io/about/" title="关于">关于</a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>

    <div id="body">
        <div class="container">
            <div class="col-group">

                <div class="col-8" id="main">
                    
<div class="res-cons">
    
    <article class="post">
        <header>
            <h1 class="post-title">hpa 源码分析</h1>
        </header>
        <date class="post-meta meta-date">
            2021年6月18日
        </date>
        
        <div class="post-meta">
            <span>|</span>
            
            <span class="meta-category"><a href='/categories/k8s'>k8s</a></span>
            
        </div>
        
        
        <div class="post-meta">
            <span id="busuanzi_container_page_pv">|<span id="busuanzi_value_page_pv"></span><span>
                    阅读</span></span>
        </div>
        
        
        <div class="post-content">
            

<p><strong>本章重点：</strong> 从源码角度分析hpa的计算逻辑</p>

<h3 id="1-hpa介绍">1. hpa介绍</h3>

<h4 id="1-1-hpa是什么">1.1 hpa是什么</h4>

<p>hpa指的是 Pod 水平自动扩缩，全名是Horizontal Pod Autoscaler简称HPA。它可以基于 CPU 利用率或其他指标自动扩缩 ReplicationController、Deployment 和 ReplicaSet 中的 Pod 数量。</p>

<p><strong>用处：</strong>  用户可以通过设置hpa，实现deploy pod数量的自动扩缩容。比如流量大的时候，pod数量多一些。流量小的时候，Pod数量降下来，避免资源浪费。</p>

<p><img src="../../resources/images/hpa/hap-1.png" alt="image-20210521145344510" /></p>

<p><br></p>

<h4 id="1-2-hpa如何用起来">1.2 hpa如何用起来</h4>

<p>（1）需要一个deploy/svc等，可以参考社区</p>

<p>（2）需要对应的hpa</p>

<p>举例：</p>

<p>(1) 创建1个deploy。这里只有1个副本</p>
<pre><code>apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: zx-hpa-test
  name: zx-hpa
spec:
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
  replicas: 2
  selector:
    matchLabels:
      app: zx-hpa-test
  template:
    metadata:
      labels:
        app: zx-hpa-test
      name: zx-hpa-test
    spec:
      terminationGracePeriodSeconds: 5
      containers:
        - name: busybox
          image: busybox:latest
          imagePullPolicy: IfNotPresent
          command:
            - sleep
            - &#34;3600&#34;</code></pre>
<p>（2）创建对应的hpa。</p>
<pre><code>apiVersion: autoscaling/v2beta1
kind: HorizontalPodAutoscaler
metadata:
  name: nginx-hpa-zx-1
  annotations:
    metric-containerName: zx-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1   // 这里必须指定需要监控那个对象
    kind: Deployment
    name: zx-hpa
  minReplicas: 1          // deploy最小的Pod数量
  maxReplicas: 3          // deploy最大的Pod数量
  metrics:
    - type: Pods
      pods:
        metricName: pod_cpu_1m
        targetAverageValue: 60</code></pre>
<p>hpa是从同命名空间下，找对应的deploy。所以yaml中指定deploy的时候不要指定namespaces。这也就要求，hpa 和deploy必须在同一命名空间。</p>

<p><br></p>

<p>这里我使用的 pod_cpu_1m这个指标。这是一个自定义指标。接下来就是分析</p>

<p>创建好之后，观察hpa，当deploy的cpu利用率变化时，deploy的副本会随之改变。</p>

<p><br></p>

<h3 id="2-hpa-源码分析">2. hpa 源码分析</h3>

<h4 id="2-1-启动参数介绍">2.1 启动参数介绍</h4>

<p>hpa controller随controller manager的初始化而启动，hpa controller将以下flag添加到controller manager的flag中，通过controller manager的CLI端暴露给用户：</p>
<pre><code>// AddFlags adds flags related to HPAController for controller manager to the specified FlagSet.
func (o *HPAControllerOptions) AddFlags(fs *pflag.FlagSet) {
	if o == nil {
		return
	}

	fs.DurationVar(&amp;o.HorizontalPodAutoscalerSyncPeriod.Duration, &#34;horizontal-pod-autoscaler-sync-period&#34;, o.HorizontalPodAutoscalerSyncPeriod.Duration, &#34;The period for syncing the number of pods in horizontal pod autoscaler.&#34;)
	fs.DurationVar(&amp;o.HorizontalPodAutoscalerUpscaleForbiddenWindow.Duration, &#34;horizontal-pod-autoscaler-upscale-delay&#34;, o.HorizontalPodAutoscalerUpscaleForbiddenWindow.Duration, &#34;The period since last upscale, before another upscale can be performed in horizontal pod autoscaler.&#34;)
	fs.MarkDeprecated(&#34;horizontal-pod-autoscaler-upscale-delay&#34;, &#34;This flag is currently no-op and will be deleted.&#34;)
	fs.DurationVar(&amp;o.HorizontalPodAutoscalerDownscaleStabilizationWindow.Duration, &#34;horizontal-pod-autoscaler-downscale-stabilization&#34;, o.HorizontalPodAutoscalerDownscaleStabilizationWindow.Duration, &#34;The period for which autoscaler will look backwards and not scale down below any recommendation it made during that period.&#34;)
	fs.DurationVar(&amp;o.HorizontalPodAutoscalerDownscaleForbiddenWindow.Duration, &#34;horizontal-pod-autoscaler-downscale-delay&#34;, o.HorizontalPodAutoscalerDownscaleForbiddenWindow.Duration, &#34;The period since last downscale, before another downscale can be performed in horizontal pod autoscaler.&#34;)
	fs.MarkDeprecated(&#34;horizontal-pod-autoscaler-downscale-delay&#34;, &#34;This flag is currently no-op and will be deleted.&#34;)
	fs.Float64Var(&amp;o.HorizontalPodAutoscalerTolerance, &#34;horizontal-pod-autoscaler-tolerance&#34;, o.HorizontalPodAutoscalerTolerance, &#34;The minimum change (from 1.0) in the desired-to-actual metrics ratio for the horizontal pod autoscaler to consider scaling.&#34;)
	fs.BoolVar(&amp;o.HorizontalPodAutoscalerUseRESTClients, &#34;horizontal-pod-autoscaler-use-rest-clients&#34;, o.HorizontalPodAutoscalerUseRESTClients, &#34;If set to true, causes the horizontal pod autoscaler controller to use REST clients through the kube-aggregator, instead of using the legacy metrics client through the API server proxy.  This is required for custom metrics support in the horizontal pod autoscaler.&#34;)
	fs.DurationVar(&amp;o.HorizontalPodAutoscalerCPUInitializationPeriod.Duration, &#34;horizontal-pod-autoscaler-cpu-initialization-period&#34;, o.HorizontalPodAutoscalerCPUInitializationPeriod.Duration, &#34;The period after pod start when CPU samples might be skipped.&#34;)
	fs.MarkDeprecated(&#34;horizontal-pod-autoscaler-use-rest-clients&#34;, &#34;Heapster is no longer supported as a source for Horizontal Pod Autoscaler metrics.&#34;)
	fs.DurationVar(&amp;o.HorizontalPodAutoscalerInitialReadinessDelay.Duration, &#34;horizontal-pod-autoscaler-initial-readiness-delay&#34;, o.HorizontalPodAutoscalerInitialReadinessDelay.Duration, &#34;The period after pod start during which readiness changes will be treated as initial readiness.&#34;)
}</code></pre>
<table>
<thead>
<tr>
<th align="left">参数</th>
<th align="left">默认</th>
<th align="left">说明</th>
</tr>
</thead>

<tbody>
<tr>
<td align="left">horizontal-pod-autoscaler-sync-period</td>
<td align="left">15s</td>
<td align="left">controller同步HPA信息的同步周期</td>
</tr>

<tr>
<td align="left">horizontal-pod-autoscaler-downscale-stabilization</td>
<td align="left">5m</td>
<td align="left">缩容稳定窗口，缩容间隔时间（v1.12支持）</td>
</tr>

<tr>
<td align="left">horizontal-pod-autoscaler-tolerance</td>
<td align="left">0.1</td>
<td align="left">最小缩放容忍度：计算出的期望值和实际值的比率&lt;最小容忍比率，则不进行扩缩容</td>
</tr>

<tr>
<td align="left">horizontal-pod-autoscaler-cpu-initialization-period</td>
<td align="left">5m</td>
<td align="left">pod刚启动时，一定时间内的CPU使用率数据不参与计算。</td>
</tr>

<tr>
<td align="left">horizontal-pod-autoscaler-initial-readiness-delay</td>
<td align="left">30s</td>
<td align="left">扩容等待pod ready的时间（无法得知pod何时就绪）</td>
</tr>
</tbody>
</table>

<p>kcm中需要设置这个，才能启动自定义的rest-clients。   &ndash;horizontal-pod-autoscaler-use-rest-clients=true</p>

<p><br></p>

<h4 id="2-2-启动流程">2.2 启动流程</h4>

<p>**代码流程： **</p>

<p>startHPAControllerWithMetricsClient -&gt; startHPAControllerWithMetricsClient -&gt; Run -&gt; worker -&gt; processNextWorkItem -&gt; reconcileKey-&gt;reconcileAutoscaler</p>
<pre><code>func (a *HorizontalController) reconcileKey(key string) (deleted bool, err error) {
	namespace, name, err := cache.SplitMetaNamespaceKey(key)
	if err != nil {
		return true, err
	}

	hpa, err := a.hpaLister.HorizontalPodAutoscalers(namespace).Get(name)
	if errors.IsNotFound(err) {
		klog.Infof(&#34;Horizontal Pod Autoscaler %s has been deleted in %s&#34;, name, namespace)
		delete(a.recommendations, key)
		return true, nil
	}

	return false, a.reconcileAutoscaler(hpa, key)
}</code></pre>
<p><br></p>

<h4 id="2-3-核心计算逻辑">2.3 核心计算逻辑</h4>

<p><strong>metric的定义类型分为3种，resource、pods和external，这里只分析pods类型的metric。</strong></p>

<p>reconcileAutoscaler函数就是hpa的核心函数。该函数主要逻辑如下：</p>

<ul>
<li>1.做一些类型转换，用于接下来的Hpa计算</li>
<li>2.计算hpa 的期望副本数量。</li>

<li><p>3.根据计算的结果判断是否需要改变副本数，需要改变的话，调用接口修改，然后做错误处理。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">68
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">69
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">70
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">71
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">72
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">73
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">74
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">75
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">76
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">77
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">78
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">79
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">80
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">81
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">82
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">83
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">84
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#000;font-weight:bold">func</span> (a <span style="color:#000;font-weight:bold">*</span>HorizontalController) <span style="color:#900;font-weight:bold">reconcileAutoscaler</span>(hpav1Shared <span style="color:#000;font-weight:bold">*</span>autoscalingv1.HorizontalPodAutoscaler, key <span style="color:#458;font-weight:bold">string</span>) <span style="color:#458;font-weight:bold">error</span> {
	<span style="color:#998;font-style:italic">// 1. 调用client向apiserver发送请求，scale是返回的hpa实体,然后做各种数据类型转换，然后通过一个client向apiserver获取scale，以及当然还有一些backup、把错误写入hpa event的操作
</span><span style="color:#998;font-style:italic"></span><span style="color:#a61717;background-color:#e3d2d2">。。。。</span>代码省略

<span style="color:#998;font-style:italic">// 2. 判断是否需要计算副本数，如果需要，就调用computeReplicasForMetrics函数计算当前hpa的副本数。
</span><span style="color:#998;font-style:italic"></span>	desiredReplicas <span style="color:#000;font-weight:bold">:=</span> <span style="color:#0086b3">int32</span>(<span style="color:#099">0</span>)
	rescaleReason <span style="color:#000;font-weight:bold">:=</span> <span style="color:#d14">&#34;&#34;</span>

	<span style="color:#000;font-weight:bold">var</span> minReplicas <span style="color:#458;font-weight:bold">int32</span>

	<span style="color:#000;font-weight:bold">if</span> hpa.Spec.MinReplicas <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
		minReplicas = <span style="color:#000;font-weight:bold">*</span>hpa.Spec.MinReplicas
	} <span style="color:#000;font-weight:bold">else</span> {
		<span style="color:#998;font-style:italic">// Default value
</span><span style="color:#998;font-style:italic"></span>		minReplicas = <span style="color:#099">1</span>
	}

	rescale <span style="color:#000;font-weight:bold">:=</span> <span style="color:#000;font-weight:bold">true</span>

	<span style="color:#000;font-weight:bold">if</span> scale.Spec.Replicas <span style="color:#000;font-weight:bold">==</span> <span style="color:#099">0</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> minReplicas <span style="color:#000;font-weight:bold">!=</span> <span style="color:#099">0</span> {
		<span style="color:#998;font-style:italic">// Autoscaling is disabled for this resource
</span><span style="color:#998;font-style:italic"></span>		desiredReplicas = <span style="color:#099">0</span>
		rescale = <span style="color:#000;font-weight:bold">false</span>
		<span style="color:#900;font-weight:bold">setCondition</span>(hpa, autoscalingv2.ScalingActive, v1.ConditionFalse, <span style="color:#d14">&#34;ScalingDisabled&#34;</span>, <span style="color:#d14">&#34;scaling is disabled since the replica count of the target is zero&#34;</span>)
	} <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">if</span> currentReplicas &gt; hpa.Spec.MaxReplicas {
		rescaleReason = <span style="color:#d14">&#34;Current number of replicas above Spec.MaxReplicas&#34;</span>
		desiredReplicas = hpa.Spec.MaxReplicas
	} <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">if</span> currentReplicas &lt; minReplicas {
		rescaleReason = <span style="color:#d14">&#34;Current number of replicas below Spec.MinReplicas&#34;</span>
		desiredReplicas = minReplicas
	} <span style="color:#000;font-weight:bold">else</span> {
		<span style="color:#000;font-weight:bold">var</span> metricTimestamp time.Time
		metricDesiredReplicas, metricName, metricStatuses, metricTimestamp, err = a.<span style="color:#900;font-weight:bold">computeReplicasForMetrics</span>(hpa, scale, hpa.Spec.Metrics)
		<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
			a.<span style="color:#900;font-weight:bold">setCurrentReplicasInStatus</span>(hpa, currentReplicas)
			<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">:=</span> a.<span style="color:#900;font-weight:bold">updateStatusIfNeeded</span>(hpaStatusOriginal, hpa); err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
				utilruntime.<span style="color:#900;font-weight:bold">HandleError</span>(err)
			}
			a.eventRecorder.<span style="color:#900;font-weight:bold">Event</span>(hpa, v1.EventTypeWarning, <span style="color:#d14">&#34;FailedComputeMetricsReplicas&#34;</span>, err.<span style="color:#900;font-weight:bold">Error</span>())
			<span style="color:#000;font-weight:bold">return</span> fmt.<span style="color:#900;font-weight:bold">Errorf</span>(<span style="color:#d14">&#34;failed to compute desired number of replicas based on listed metrics for %s: %v&#34;</span>, reference, err)
		}

		klog.<span style="color:#900;font-weight:bold">V</span>(<span style="color:#099">4</span>).<span style="color:#900;font-weight:bold">Infof</span>(<span style="color:#d14">&#34;proposing %v desired replicas (based on %s from %s) for %s&#34;</span>, metricDesiredReplicas, metricName, metricTimestamp, reference)

		rescaleMetric <span style="color:#000;font-weight:bold">:=</span> <span style="color:#d14">&#34;&#34;</span>
		<span style="color:#000;font-weight:bold">if</span> metricDesiredReplicas &gt; desiredReplicas {
			desiredReplicas = metricDesiredReplicas
			rescaleMetric = metricName
		}
		<span style="color:#000;font-weight:bold">if</span> desiredReplicas &gt; currentReplicas {
			rescaleReason = fmt.<span style="color:#900;font-weight:bold">Sprintf</span>(<span style="color:#d14">&#34;%s above target&#34;</span>, rescaleMetric)
		}
		<span style="color:#000;font-weight:bold">if</span> desiredReplicas &lt; currentReplicas {
			rescaleReason = <span style="color:#d14">&#34;All metrics below target&#34;</span>
		}
		desiredReplicas = a.<span style="color:#900;font-weight:bold">normalizeDesiredReplicas</span>(hpa, key, currentReplicas, desiredReplicas, minReplicas)
		rescale = desiredReplicas <span style="color:#000;font-weight:bold">!=</span> currentReplicas
	}
  
<span style="color:#998;font-style:italic">// 3.进行扩缩容，并进行错误处理。
</span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">if</span> rescale {
		scale.Spec.Replicas = desiredReplicas
		_, err = a.scaleNamespacer.<span style="color:#900;font-weight:bold">Scales</span>(hpa.Namespace).<span style="color:#900;font-weight:bold">Update</span>(targetGR, scale)
		<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
			a.eventRecorder.<span style="color:#900;font-weight:bold">Eventf</span>(hpa, v1.EventTypeWarning, <span style="color:#d14">&#34;FailedRescale&#34;</span>, <span style="color:#d14">&#34;New size: %d; reason: %s; error: %v&#34;</span>, desiredReplicas, rescaleReason, err.<span style="color:#900;font-weight:bold">Error</span>())
			<span style="color:#900;font-weight:bold">setCondition</span>(hpa, autoscalingv2.AbleToScale, v1.ConditionFalse, <span style="color:#d14">&#34;FailedUpdateScale&#34;</span>, <span style="color:#d14">&#34;the HPA controller was unable to update the target scale: %v&#34;</span>, err)
			a.<span style="color:#900;font-weight:bold">setCurrentReplicasInStatus</span>(hpa, currentReplicas)
			<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">:=</span> a.<span style="color:#900;font-weight:bold">updateStatusIfNeeded</span>(hpaStatusOriginal, hpa); err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
				utilruntime.<span style="color:#900;font-weight:bold">HandleError</span>(err)
			}
			<span style="color:#000;font-weight:bold">return</span> fmt.<span style="color:#900;font-weight:bold">Errorf</span>(<span style="color:#d14">&#34;failed to rescale %s: %v&#34;</span>, reference, err)
		}
		<span style="color:#900;font-weight:bold">setCondition</span>(hpa, autoscalingv2.AbleToScale, v1.ConditionTrue, <span style="color:#d14">&#34;SucceededRescale&#34;</span>, <span style="color:#d14">&#34;the HPA controller was able to update the target scale to %d&#34;</span>, desiredReplicas)
		a.eventRecorder.<span style="color:#900;font-weight:bold">Eventf</span>(hpa, v1.EventTypeNormal, <span style="color:#d14">&#34;SuccessfulRescale&#34;</span>, <span style="color:#d14">&#34;New size: %d; reason: %s&#34;</span>, desiredReplicas, rescaleReason)
		klog.<span style="color:#900;font-weight:bold">Infof</span>(<span style="color:#d14">&#34;Successful rescale of %s, old size: %d, new size: %d, reason: %s&#34;</span>,
			hpa.Name, currentReplicas, desiredReplicas, rescaleReason)
	} <span style="color:#000;font-weight:bold">else</span> {
		klog.<span style="color:#900;font-weight:bold">V</span>(<span style="color:#099">4</span>).<span style="color:#900;font-weight:bold">Infof</span>(<span style="color:#d14">&#34;decided not to scale %s to %v (last scale time was %s)&#34;</span>, reference, desiredReplicas, hpa.Status.LastScaleTime)
		desiredReplicas = currentReplicas
	}

	a.<span style="color:#900;font-weight:bold">setStatus</span>(hpa, currentReplicas, desiredReplicas, metricStatuses, rescale)
	<span style="color:#000;font-weight:bold">return</span> a.<span style="color:#900;font-weight:bold">updateStatusIfNeeded</span>(hpaStatusOriginal, hpa)
}</code></pre></td></tr></table>
</div>
</div></li>
</ul>

<p><br></p>

<p><strong>这里主要关心第二个步骤：hpa如何计算期望副本数量</strong></p>

<h4 id="2-4-计算期望副本数量">2.4  计算期望副本数量</h4>

<p>概念：</p>

<p>最小值：minReplicas。 这个是用户在hpa里面的yaml设置的。这个是可选的，如果不设置，默认是1。</p>

<p>最大值：MaxReplicas。 这个是用户在hpa里面的yaml设置的。这个必填的，如果不设置，会报错, 如下。</p>

<p>当前值：currentReplicas。这个是hpa获得的当前deploy的副本数量。</p>

<p>期望值：desiredReplicas。 这个是hpa希望deploy的副本数量。</p>
<pre><code>error: error validating &#34;nginx-deployment-hpa-test.yaml&#34;: error validating data: ValidationError(HorizontalPodAutoscaler.spec): missing required field &#34;maxReplicas&#34; in io.k8s.api.autoscaling.v2beta1.HorizontalPodAutoscalerSpec; if you choose to ignore these errors, turn validation off with --validate=false</code></pre>
<p>计算逻辑分为两部分，第一种情况是不需要算，就可以直接得出期望值。 第二种情况需要调用函数计算。</p>

<p><strong>情况1：不需要计算</strong></p>

<p>（1）当前值等于0。        期望值=0.    不扩容，</p>

<p>（2）当前值 &gt; 最大值。    没必要计算期望值。 期望值=最大值，需要扩缩容。</p>

<p>（3）当前值 &lt; 最小值。   没必要计算期望值。 期望值=最小值，需要扩缩容。</p>

<p><br></p>

<p><strong>情况2：</strong>    最小值  &lt;= 当前值  &lt;= 最大值。 需要调用函数计算 期望值。</p>

<p>这里的调用链为  computeReplicasForMetrics -&gt; computeReplicasForMetric -&gt; GetMetricReplicas</p>

<p>这里computeReplicasForMetrics有一个需要注意的点就是。这里可以处理了多个metric的情况。例如：这里一个hpa有多个指标。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text"> - type: Resource
    resource:
      name: cpu
      # Utilization类型的目标值，Resource类型的指标只支持Utilization和AverageValue类型的目标值
      target:
        type: Utilization
        averageUtilization: 50
  # Pods类型的指标
  - type: Pods
    pods:
      metric:
        name: packets-per-second
      # AverageValue类型的目标值，Pods指标类型下只支持AverageValue类型的目标值
      target:
        type: AverageValue
        averageValue: 1k</code></pre></td></tr></table>
</div>
</div>
<p>这里hpa的逻辑是，谁最大取谁。例如, 通过cpu.Utilization hpa算出来应该需要 4个pod。 但是packets-per-second算出来需要5个。这个时候就已5个为准。见下面代码：</p>
<pre><code>// computeReplicasForMetrics computes the desired number of replicas for the metric specifications listed in the HPA,
// returning the maximum  of the computed replica counts, a description of the associated metric, and the statuses of
// all metrics computed.
func (a *HorizontalController) computeReplicasForMetrics(hpa *autoscalingv2.HorizontalPodAutoscaler, scale *autoscalingv1.Scale,
	metricSpecs []autoscalingv2.MetricSpec) (replicas int32, metric string, statuses []autoscalingv2.MetricStatus, timestamp time.Time, err error) {

	for i, metricSpec := range metricSpecs {
		replicaCountProposal, metricNameProposal, timestampProposal, condition, err := a.computeReplicasForMetric(hpa, metricSpec, specReplicas, statusReplicas, selector, &amp;statuses[i])

		if err != nil {
			if invalidMetricsCount &lt;= 0 {
				invalidMetricCondition = condition
				invalidMetricError = err
			}
			invalidMetricsCount++
		}
		if err == nil &amp;&amp; (replicas == 0 || replicaCountProposal &gt; replicas) {
			timestamp = timestampProposal
			replicas = replicaCountProposal
			metric = metricNameProposal
		}
	}

	// If all metrics are invalid return error and set condition on hpa based on first invalid metric.
	if invalidMetricsCount &gt;= len(metricSpecs) {
		setCondition(hpa, invalidMetricCondition.Type, invalidMetricCondition.Status, invalidMetricCondition.Reason, invalidMetricCondition.Message)
		return 0, &#34;&#34;, statuses, time.Time{}, fmt.Errorf(&#34;invalid metrics (%v invalid out of %v), first error is: %v&#34;, invalidMetricsCount, len(metricSpecs), invalidMetricError)
	}
	setCondition(hpa, autoscalingv2.ScalingActive, v1.ConditionTrue, &#34;ValidMetricFound&#34;, &#34;the HPA was able to successfully calculate a replica count from %s&#34;, metric)
	return replicas, metric, statuses, timestamp, nil
}</code></pre>
<p><br></p>

<p>针对具体某个metric指标。计算分为俩步：</p>

<p>（1）GetRawMetric函数： 得到 具体的metric值</p>

<p>（2）calcPlainMetricReplicas ：计算期望副本值</p>

<p>这里需要注意一点就是targetUtilization进行了数据转换。乘以了10^3。</p>
<pre><code>// GetMetricReplicas calculates the desired replica count based on a target metric utilization
// (as a milli-value) for pods matching the given selector in the given namespace, and the
// current replica count
func (c *ReplicaCalculator) GetMetricReplicas(currentReplicas int32, targetUtilization int64, metricName string, namespace string, selector labels.Selector, metricSelector labels.Selector) (replicaCount int32, utilization int64, timestamp time.Time, err error) {
	metrics, timestamp, err := c.metricsClient.GetRawMetric(metricName, namespace, selector, metricSelector)
	if err != nil {
		return 0, 0, time.Time{}, fmt.Errorf(&#34;unable to get metric %s: %v&#34;, metricName, err)
	}

	replicaCount, utilization, err = c.calcPlainMetricReplicas(metrics, currentReplicas, targetUtilization, namespace, selector, v1.ResourceName(&#34;&#34;))
	return replicaCount, utilization, timestamp, err
}</code></pre>
<p><br></p>

<h5 id="2-4-1-getrawmetric-具体的metric值">2.4.1 GetRawMetric-具体的metric值</h5>
<pre><code>// GetRawMetric gets the given metric (and an associated oldest timestamp)
// for all pods matching the specified selector in the given namespace
func (c *customMetricsClient) GetRawMetric(metricName string, namespace string, selector labels.Selector, metricSelector labels.Selector) (PodMetricsInfo, time.Time, error) {
  // 1.这里直接调用 GetForObjects，发送restful请求获取数据
	metrics, err := c.client.NamespacedMetrics(namespace).GetForObjects(schema.GroupKind{Kind: &#34;Pod&#34;}, selector, metricName, metricSelector)
	if err != nil {
		return nil, time.Time{}, fmt.Errorf(&#34;unable to fetch metrics from custom metrics API: %v&#34;, err)
	}

	if len(metrics.Items) == 0 {
		return nil, time.Time{}, fmt.Errorf(&#34;no metrics returned from custom metrics API&#34;)
	}
  
  // 2. 对获取的数据进行处理。这里看起来是乘以了 10^3
	res := make(PodMetricsInfo, len(metrics.Items))
	for _, m := range metrics.Items {
		window := metricServerDefaultMetricWindow
		if m.WindowSeconds != nil {
			window = time.Duration(*m.WindowSeconds) * time.Second
		}
		res[m.DescribedObject.Name] = PodMetric{
			Timestamp: m.Timestamp.Time,
			Window:    window,
			Value:     int64(m.Value.MilliValue()),
		}

		m.Value.MilliValue()
	}

	timestamp := metrics.Items[0].Timestamp.Time

	return res, timestamp, nil
}</code></pre>
<p><br></p>

<h5 id="2-4-2-calcplainmetricreplicas-计算期望副本值">2.4.2 calcPlainMetricReplicas-计算期望副本值</h5>

<p>这里代码省略，直接贴逻辑。</p>

<p>3.1 先从apiserver端拿到所有相关的pod，将这些pod分为三类：</p>
<pre><code>a.missingPods用于记录处于running状态，但不提供该metric的pod

b.ignoredPods 用于处理resource类型cpu相关metric的延迟（就是pod未就绪），这里不深入讨论

c.readyPodCount记录状态为running，且能提供该metric的pod</code></pre>
<p>3.2 调用GetMetricUtilizationRatio计算实际值与期望值的对比情况。计算时，对于所有可获取到metric的pod，取它们metric value的平均值得到：usageRatio=实际值/期望值；utilization=实际值（平均）</p>

<p>3.3 计算期望pod数量DesiredReplicas。对于missingPods为0，即所有target pod都处于running可获取metric value的情况:</p>

<p>a.如果实际值与期望值的对比usageRatio处于可容忍范围内，不执行scale操作。默认情况下c.tolerance=0.1，即usageRatio处于</p>

<p>[0.9,1.1]时pod数量不变化</p>
<pre><code>if math.Abs(1.0-usageRatio) &lt;= c.tolerance {
    // return the current replicas if the change would be too small
    return currentReplicas, utilization, nil
}</code></pre>
<p>b.实际值与期望值的对比usageRatio不在可容忍范围内，向上取整得到desiredReplicas
 <code>return int32(math.Ceil(usageRatio * float64(readyPodCount))), utilization, nil</code></p>

<p>对于missingPods&gt;0，即有target pod的metric value没有获取到的情况。 缩容时，对于找不到metric的pod，<code>视为</code>正好用了desired value</p>
<pre><code>if usageRatio &lt; 1.0 {
// on a scale-down, treat missing pods as using 100% of the resource request
for podName := range missingPods {
	metrics[podName] = metricsclient.PodMetric{Value: targetUtilization}
        }
} </code></pre>
<p>扩容时，对于找不到metric的pod，<code>视为</code>该pod对指定metric的使用量为0</p>
<pre><code>for podName := range missingPods {
	metrics[podName] = metricsclient.PodMetric{Value: 0}
}</code></pre>
<p>经过上面的处理后，重新计算实际值与期望值的对比newUsageRatio。</p>

<p>在下面两种情况下，不执行scale操作：新的实际值与期望值的对比newUsageRatio在容忍范围内； 赋值处理前后，一个需要scale up，另一个需要scale down。</p>

<p>其它情况下，同样地执行向上取整操作</p>
<pre><code>if math.Abs(1.0-newUsageRatio) &lt;= c.tolerance || (usageRatio &lt; 1.0 &amp;&amp; newUsageRatio &gt; 1.0) || (usageRatio &gt; 1.0 &amp;&amp; newUsageRatio &lt; 1.0) {
		// return the current replicas if the change would be too small,
		// or if the new usage ratio would cause a change in scale direction
		return currentReplicas, utilization, nil
	}
return int32(math.Ceil(newUsageRatio * float64(len(metrics)))), utilization, nil</code></pre>
<p><br></p>

<p>最后，Hpa将desiredReplicas写到scale.Spec.Replicas，调用a.scaleNamespacer.Scales(hpa.Namespace).Update(targetGR, scale)向apiserver发送更新hpa的请求，对某个hpa的一轮更新操作就完成了。</p>

<p><br></p>

<h3 id="3-举例说明计算过程">3. 举例说明计算过程</h3>

<h4 id="3-1-hpa扩容计算逻辑">3.1 hpa扩容计算逻辑</h4>

<p><strong>关键概念</strong>：tolerance（hpa扩容容忍度）， 默认为0.1。</p>

<p>Custom server: 自定义metric服务。这里是一个抽象，用于给hpa提供具体的metric值。Custom server具体可以是prometheus，或者其他的监控系统。下一篇文章会讲如何将Custom server和hpa联系起来。</p>

<p><br></p>

<h4 id="3-2-场景1">3.2 场景1</h4>

<p>当前有deployA,  运行着俩个pod, A1和A2。 deploy设置了hpa，指标是内存使用量，并且规定，当平均使用量大于60就要扩容。</p>

<p><img src="../../resources/images/hpa/hpa-2.png" alt="image-20210616210849063" /></p>

<p>hpa扩容计算步骤：</p>

<p><strong>第一步:</strong>  往monitor-adaptor发送请求， 要求获得deployA下所有pod的metric值。  这里收到了 A1=50; A2=100</p>

<p><strong>第二步:</strong>  补全metric值，给获取不到metric值的pod赋值。  这里hpa会查看集群状态，发现deployA 下有俩个pod，A1,A2。并且这两个pod的metric值都获取到了。  这个时候就不用补全。（下面例子就介绍需要补全metric的情况）</p>

<p><strong>第三步:</strong>  开始计算</p>

<p>（1）计算 平均pod metric值和 target的比例。也可以叫扩容比例系数</p>
<pre><code>  ratio = (A1+A2)/(2*target) = (50+100)/120 = 1.25</code></pre>
<p>按理说不用再除target值，直接（50+100)/2=75，然后拿75和60比就行。 75比60大就应该扩容。</p>

<p>这里使用系数表示主要有俩个原因：</p>

<ul>
<li>有容忍度的概念，使用比例方便和计算是否超出了容忍度</li>
<li>用于扩缩容计算</li>
</ul>

<p>（2）判断是否超过容忍度</p>

<p>这里 1.25-1 &gt; 0.1(默认容忍度)。 因此这种情况是需要扩容的。</p>

<p>这里就体现了容忍度的作用。有了容忍度, 平均metric需要大于 66才会扩容（60*1.1）</p>

<p>（3）计算真正的副本数量</p>

<p>向上取整： 扩容比例系数*当前的副本数</p>

<p>这里就是： 1.25*2 = 2.5 , 取整后就是3。</p>

<p><br></p>

<h4 id="3-3-场景2">3.3 场景2</h4>

<p>和场景1不同在于：由于某件原因，导致 monitor-adaptor往hpa发送的时候，只有  A1=20。 A2的数据丢失。</p>

<p><img src="../../resources/images/hpa/hpa-3.png" alt="image-20210616211337218" />hpa扩容计算步骤：</p>

<p><strong>第一步:</strong>  往monitor-adaptor发送请求， 要求获得deployA下所有pod的metric值。  这里收到了 A1=2;</p>

<p><strong>第二步:</strong>  补全metric值，给获取不到metric值的pod赋值。  这里hpa会查看集群状态，发现deployA 下有俩个pod，A1,A2。但是这里发现只有A1的值，这个时候hpa就认为A2 有数据，但是获取失败。所以就会给A2自己赋值， 0/target。</p>

<p>赋值逻辑如下：  当 A1 &gt; target的时候，A2=0;  当A1&lt;= target的时候，赋值为 target。</p>

<p>这里由于 A1=2, 比target(60)小，所以最终hpa计算时:</p>

<p>A1=2; A2=60; target=60;</p>

<p><strong>第三步:</strong>  开始计算</p>

<p>（1）计算 平均pod metric值和 target的比例。也可以叫扩容比例系数</p>
<pre><code>  ratio = (A1+A2)/(2*target) = (2+60)/120 = 0.517</code></pre>
<p>（2）判断是否超过容忍度</p>

<p>这里 1-0.517 &gt; 0.1(默认容忍度)。 因此这种情况是需要缩容的。</p>

<p>（3）计算真正的副本数量</p>

<p>向上取整： 扩容比例系数*当前的副本数（这里就是metric数量，A1,A2）</p>

<p>对应就是： 0.517*2 = 1.034 , 取整后就是2。</p>

<p><br></p>

<h3 id="4-总结">4. 总结</h3>

<p>（1）hpa可以设置多个metric。当有多个metric时，谁算出来的副本值最大，取谁的值</p>

<p>（2）针对具体的metric而言（这里是以pods这种为例），首先获得用户定义的hpa指标。比如最大值，最小值，阈值等。</p>

<p>这里有一个点在于。阈值乘以了1000用于计算。</p>

<p>（3）获取metric的值，这里是使用了自定义rest服务。hpa只要发送rest请求，就有数据。这种情况非常适用于公司使用自己的监控数据做扩缩容。 注意：这里每个值也乘以了1000。这样和阈值就是相互抵消了。</p>

<p>（4）利用公式计算期望值。  期望值*X &lt;= 当前pod所有的metric值。X取小的正整数。具体逻辑可以看上文的计算过程。</p>

        </div>

        


        

<div class="post-archive">
    <h2>See Also</h2>
    <ul class="listing">
        
        <li><a href="/post/2019-12-15-k8s%E7%9A%84%E5%9F%BA%E6%9C%AC%E7%BB%84%E4%BB%B6/">k8s的基本组件</a></li>
        
        <li><a href="/post/2019-11-24-k8s%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0-scheduler%E7%AC%94%E8%AE%B01/">k8s源码学习 - Scheduler笔记（1）</a></li>
        
        <li><a href="/post/2019-11-24-k8s%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0-scheduler%E7%AC%94%E8%AE%B02/">k8s源码学习 - Scheduler笔记（2）</a></li>
        
        <li><a href="/post/2019-11-24-k8s%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0-%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84/">k8s源码学习--代码结构</a></li>
        
        <li><a href="/post/2019-11-24-k8s%E9%9B%86%E7%BE%A4%E5%AE%89%E8%A3%85helm/">k8s集群安装helm</a></li>
        
    </ul>
</div>


        <div class="post-meta meta-tags">
            
            <ul class="clearfix">
                
                <li><a href='/tags/k8s'>k8s</a></li>
                
            </ul>
            
        </div>
    </article>
    
    

    
    
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "zoux86/blog"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
    
</div>

                    <footer id="footer">
    <div>
        &copy; 2021 <a href="https://zoux86.github.io/">zoux的博客 By zoux</a>
        
    </div>
    <br />
    <div>
        <div class="github-badge">
            <a href="https://gohugo.io/" target="_black" rel="nofollow"><span class="badge-subject">Powered by</span><span class="badge-value bg-blue">Hugo</span></a>
        </div>
        <div class="github-badge">
            <a href="https://www.flysnow.org/" target="_black"><span class="badge-subject">Design by</span><span class="badge-value bg-brightgreen">飞雪无情</span></a>
        </div>
        <div class="github-badge">
            <a href="https://github.com/flysnow-org/maupassant-hugo" target="_black"><span class="badge-subject">Theme</span><span class="badge-value bg-yellowgreen">Maupassant</span></a>
        </div>
    </div>
</footer>


    
    <script type="text/javascript">
        window.MathJax = {
            tex2jax: {
                inlineMath: [['$', '$']],
                processEscapes: true
                }
            };
    </script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script>

<a id="rocket" href="#top"></a>
<script type="text/javascript" src='/js/totop.js?v=0.0.0' async=""></script>



    <script type="text/javascript" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>




                </div>

                <div id="secondary">
    <section class="widget">
        <form id="search" action='https://zoux86.github.io/search/' method="get" accept-charset="utf-8" target="_blank" _lpchecked="1">
      
      <input type="text" name="q" maxlength="20" placeholder="Search">
      <input type="hidden" name="sitesearch" value="https://zoux86.github.io/">
      <button type="submit" class="submit icon-search"></button>
</form>
    </section>
    
    <section class="widget">
        <h3 class="widget-title">最近文章</h3>
<ul class="widget-list">
    
    <li>
        <a href="https://zoux86.github.io/post/2021-7-6-k8s-rs-controller-manager%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" title="k8s rs controller源码分析">k8s rs controller源码分析</a>
    </li>
    
    <li>
        <a href="https://zoux86.github.io/post/2021-7-6-deployment-controller-manager%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" title="k8s deploy controller源码分析">k8s deploy controller源码分析</a>
    </li>
    
    <li>
        <a href="https://zoux86.github.io/post/2020-6-26-kubelet%E4%BA%8B%E4%BB%B6%E5%A4%84%E7%90%86%E6%9C%BA%E5%88%B6%E8%AF%A6%E8%A7%A3/" title="kubelet事件处理机制详解">kubelet事件处理机制详解</a>
    </li>
    
    <li>
        <a href="https://zoux86.github.io/post/2021-6-26-k8s-event%E4%BB%8B%E7%BB%8D/" title="k8s event介绍">k8s event介绍</a>
    </li>
    
    <li>
        <a href="https://zoux86.github.io/post/2021-6-18-hpa-%E8%87%AA%E5%AE%9A%E4%B9%89metric-server/" title="自定义metric server">自定义metric server</a>
    </li>
    
    <li>
        <a href="https://zoux86.github.io/post/2021-6-18-hpa%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" title="hpa 源码分析">hpa 源码分析</a>
    </li>
    
    <li>
        <a href="https://zoux86.github.io/post/2019-12-15-k8s%E7%9A%84%E5%9F%BA%E6%9C%AC%E7%BB%84%E4%BB%B6/" title="k8s的基本组件">k8s的基本组件</a>
    </li>
    
    <li>
        <a href="https://zoux86.github.io/post/2019-12-10-go%E7%9A%84%E5%90%84%E7%A7%8D%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2/" title="go的各种类型转换">go的各种类型转换</a>
    </li>
    
    <li>
        <a href="https://zoux86.github.io/post/2019-12-07-c&#43;&#43;-stl/" title="C&#43;&#43; STL">C&#43;&#43; STL</a>
    </li>
    
    <li>
        <a href="https://zoux86.github.io/post/2019-12-07-b%E6%A0%91b&#43;%E5%92%8Cb-/" title="B树,B&#43;和B-">B树,B&#43;和B-</a>
    </li>
    
</ul>
    </section>

    

    <section class="widget">
        <h3 class="widget-title"><a href='/categories/'>分类</a></h3>
<ul class="widget-list">
    
    <li><a href="https://zoux86.github.io/categories/2019%E6%A0%A1%E6%8B%9B/">2019校招 (17)</a></li>
    
    <li><a href="https://zoux86.github.io/categories/c&#43;&#43;/">C&#43;&#43; (7)</a></li>
    
    <li><a href="https://zoux86.github.io/categories/docker/">docker (2)</a></li>
    
    <li><a href="https://zoux86.github.io/categories/go/">go (1)</a></li>
    
    <li><a href="https://zoux86.github.io/categories/hadoop/">Hadoop (7)</a></li>
    
    <li><a href="https://zoux86.github.io/categories/k8s/">k8s (10)</a></li>
    
    <li><a href="https://zoux86.github.io/categories/kube-batch/">kube-batch (5)</a></li>
    
    <li><a href="https://zoux86.github.io/categories/kubeflow/">kubeflow (11)</a></li>
    
    <li><a href="https://zoux86.github.io/categories/volcano/">volcano (4)</a></li>
    
    <li><a href="https://zoux86.github.io/categories/%E4%B8%AA%E4%BA%BA%E6%84%9F%E6%82%9F/">个人感悟 (2)</a></li>
    
    <li><a href="https://zoux86.github.io/categories/%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/">环境搭建 (7)</a></li>
    
    <li><a href="https://zoux86.github.io/categories/%E7%AE%97%E6%B3%95%E9%A2%98/">算法题 (2)</a></li>
    
    <li><a href="https://zoux86.github.io/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/">读书笔记 (1)</a></li>
    
</ul>
    </section>

    <section class="widget">
        <h3 class="widget-title"><a href='/tags/'>标签</a></h3>
<div class="tagcloud">
    
    <a href="https://zoux86.github.io/tags/c&#43;&#43;/">C&#43;&#43;</a>
    
    <a href="https://zoux86.github.io/tags/clean-code/">clean code</a>
    
    <a href="https://zoux86.github.io/tags/docker/">docker</a>
    
    <a href="https://zoux86.github.io/tags/go/">go</a>
    
    <a href="https://zoux86.github.io/tags/golang/">golang</a>
    
    <a href="https://zoux86.github.io/tags/hadoop/">Hadoop</a>
    
    <a href="https://zoux86.github.io/tags/k8s/">k8s</a>
    
    <a href="https://zoux86.github.io/tags/kube-batch/">kube-batch</a>
    
    <a href="https://zoux86.github.io/tags/kubeflow/">kubeflow</a>
    
    <a href="https://zoux86.github.io/tags/tf-operator/">tf-operator</a>
    
    <a href="https://zoux86.github.io/tags/tfjob/">tfjob</a>
    
    <a href="https://zoux86.github.io/tags/ubuntu/">ubuntu</a>
    
    <a href="https://zoux86.github.io/tags/volcano/">volcano</a>
    
    <a href="https://zoux86.github.io/tags/%E4%BB%A3%E7%A0%81%E6%95%B4%E6%B4%81%E4%B9%8B%E9%81%93/">代码整洁之道</a>
    
    <a href="https://zoux86.github.io/tags/%E5%8D%9A%E5%AE%A2/">博客</a>
    
    <a href="https://zoux86.github.io/tags/%E6%84%9F%E6%82%9F/">感悟</a>
    
    <a href="https://zoux86.github.io/tags/%E6%A0%A1%E6%8B%9B/">校招</a>
    
    <a href="https://zoux86.github.io/tags/%E6%BA%90%E7%A0%81/">源码</a>
    
    <a href="https://zoux86.github.io/tags/%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/">环境搭建</a>
    
    <a href="https://zoux86.github.io/tags/%E7%AC%94%E8%AE%B0/">笔记</a>
    
    <a href="https://zoux86.github.io/tags/%E7%AE%97%E6%B3%95%E9%A2%98/">算法题</a>
    
    <a href="https://zoux86.github.io/tags/%E8%B0%83%E5%BA%A6/">调度</a>
    
</div>
    </section>

    
<section class="widget">
    <h3 class="widget-title">友情链接</h3>
    <ul class="widget-list">
        
        <li>
            <a target="_blank" href="https://www.jianshu.com/u/305d8226ced4" title="个人简书主页">个人简书主页</a>
        </li>
        
    </ul>
</section>


    <section class="widget">
        <h3 class="widget-title">其它</h3>
        <ul class="widget-list">
            <li><a href="https://zoux86.github.io/index.xml">文章 RSS</a></li>
        </ul>
    </section>
</div>
            </div>
        </div>
    </div>
</body>

</html>